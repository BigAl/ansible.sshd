---
# tasks file for sbaerlocher.sshd

- name: add OS specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
        - "defaults.yml"
      paths:
        -  "vars"
  tags:
    - configuration
    
- name: get openssh-version
  shell: ssh -V 2>&1 | sed -r 's/.*_([0-9]*\.[0-9]).*/\1/g'
  changed_when: false
  register: sshd_version
  check_mode: no
  tags:
    - configuration

- name: set hostkeys according to openssh-version
  set_fact:
    ssh_host_key_files: ['/etc/ssh/ssh_host_rsa_key', '/etc/ssh/ssh_host_ecdsa_key', '/etc/ssh/ssh_host_ed25519_key']
  when: sshd_version.stdout >= '6.3' and not ssh_host_key_files
  tags:
    - configuration

- name: set hostkeys according to openssh-version
  set_fact:
    ssh_host_key_files: ['/etc/ssh/ssh_host_rsa_key', '/etc/ssh/ssh_host_ecdsa_key']
  when: sshd_version.stdout >= '6.0' and not ssh_host_key_files
  tags:
    - configuration

- name: set hostkeys according to openssh-version
  set_fact:
    ssh_host_key_files: ['/etc/ssh/ssh_host_rsa_key']
  when: sshd_version.stdout >= '5.3' and not ssh_host_key_files
  tags:
    - configuration

- name: create sshd_config and set permissions to root/600
  become: true
  template: 
    src: "opensshd.conf.j2"
    dest: "/etc/ssh/sshd_config"
    mode: 0600 
    owner: "{{ ssh_owner }}" 
    group: "{{ ssh_group }}" 
    validate: "/usr/sbin/sshd -T -f %s"
  notify: restart sshd
  tags:
    - configuration

- name: create ssh_config and set permissions to root/644
  become: true
  template: 
    src: "openssh.conf.j2"
    dest: "/etc/ssh/ssh_config"
    mode: 0644 
    owner: "{{ ssh_owner }}"
    group: "{{ ssh_group }}"
  tags:
    - configuration